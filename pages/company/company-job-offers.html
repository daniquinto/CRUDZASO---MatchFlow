<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MatchFlow - Company Dashboard</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              ink: "#00171f",
              deep: "#003459",
              cerulean: "#007ea7",
              sky: "#00a8e8",
            },
          },
        },
      };
    </script>
  </head>

  <body class="min-h-screen bg-gray-100 text-ink">
    <!-- HEADER -->
    <header class="bg-white shadow-sm" role="banner">
      <div class="mx-auto flex max-w-7xl flex-wrap items-center justify-between gap-4 px-6 py-4">
        <a class="p-2 text-xl font-semibold text-deep" href="#" aria-label="MatchFlow">
          MatchFlow
        </a>

        <nav class="flex flex-wrap items-center gap-4 text-sm text-deep sm:gap-12" aria-label="Primary navigation">
          <a class="rounded p-2 hover:bg-sky/10 hover:text-sky" href="profile.html">Company Profile</a>
          <span class="flex flex-wrap items-center gap-4 text-sm text-deep sm:gap-12" aria-label="Primary navigation">
            Dashboard
          </span>
          <a class="rounded p-2 hover:bg-sky/10 hover:text-sky" href="search-candidate.html">Find Candidates</a>
          <a
            class="rounded border-b-2 border-sky p-2 font-medium hover:bg-sky/10 hover:text-sky"
            href="company-job-offers.html"
            aria-current="page"
          >Job Offers</a>
        </nav>

        <button
          class="rounded border px-4 py-2 text-sm font-bold text-deep shadow-sm transition-colors duration-200 hover:bg-ink hover:text-white"
          type="button"
        >
          Log Out
        </button>
      </div>
    </header>

    <!-- PAGE INTRO -->
    <section class="mx-auto max-w-7xl px-4 pt-6 sm:px-6" aria-labelledby="page-title">
      <div class="flex flex-col gap-1">
        <h1 id="page-title" class="text-2xl font-extrabold tracking-tight text-deep">
          Job Offers — <span id="companyName">—</span>
        </h1>
        <p class="text-sm text-ink/65">
          Create, publish, and manage your job offers. Matches are initiated by your company (no applications).
        </p>
      </div>
    </section>

    <!-- MAIN GRID -->
    <main class="mx-auto grid max-w-7xl grid-cols-12 gap-6 px-4 pb-10 pt-6 sm:px-6" role="main">
      <!-- SIDEBAR -->
      <aside class="col-span-12 lg:col-span-4" aria-label="Sidebar">
        <div class="space-y-6">
          <!-- Summary card -->
          <section
            class="rounded-2xl border border-ink/10 bg-white shadow-[0_10px_30px_rgba(0,23,31,0.06)]"
            aria-labelledby="summary-title"
          >
            <div class="p-5">
              <header class="flex items-start gap-4">
                <div class="grid h-12 w-12 place-items-center rounded-2xl bg-sky/10" aria-hidden="true">
                  <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
                    <path d="M3 21h18" stroke="#003459" stroke-width="2" stroke-linecap="round" />
                    <path
                      d="M7 21V7a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v14"
                      stroke="#007ea7"
                      stroke-width="2"
                      stroke-linecap="round"
                    />
                    <path d="M9 9h6" stroke="#007ea7" stroke-width="2" stroke-linecap="round" />
                    <path d="M9 13h6" stroke="#00a8e8" stroke-width="2" stroke-linecap="round" />
                  </svg>
                </div>

                <div class="min-w-0">
                  <h2 id="summary-title" class="text-sm font-extrabold text-deep">Summary</h2>
                  <p id="companyTagline" class="truncate text-xs font-semibold text-ink/60">—</p>
                </div>
              </header>

              <!-- Metrics as definition list -->
              <dl class="mt-5 grid grid-cols-2 gap-2 text-xs">
                <div class="rounded-xl bg-ink/5 p-4">
                  <dt class="font-semibold text-ink/60">Job Offers</dt>
                  <dd id="metricOffers" class="mt-1 text-sm font-extrabold text-deep">—</dd>
                </div>

                <div class="rounded-xl bg-ink/5 p-4">
                  <dt class="font-semibold text-ink/60">Active Reservations</dt>
                  <dd id="metricReservations" class="mt-1 text-sm font-extrabold text-deep">—</dd>
                </div>
              </dl>

              <div class="mt-4 grid grid-cols-1 gap-2">
                <button
                  id="newOfferBtn"
                  class="inline-flex items-center justify-center gap-2 rounded-xl bg-cerulean px-3 py-2 text-xs font-extrabold text-white hover:opacity-95 focus:outline-none focus:ring-2 focus:ring-sky"
                  type="button"
                >
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                    <path d="M12 5v14M5 12h14" stroke="white" stroke-width="2" stroke-linecap="round" />
                  </svg>
                  Create New Offer
                </button>
              </div>

              <p class="mt-4 text-[11px] text-ink/60">
                Key rule: a candidate is only visible if <strong class="font-extrabold">Open to Work</strong> is enabled.
              </p>
            </div>
          </section>

          <!-- Filters card -->
          <section
            class="rounded-2xl border border-ink/10 bg-white shadow-[0_10px_30px_rgba(0,23,31,0.06)]"
            aria-labelledby="filters-title"
          >
            <div class="p-5">
              <header>
                <h2 id="filters-title" class="text-sm font-extrabold text-deep">Filters</h2>
                <p class="mt-1 text-xs text-ink/60">Search by title.</p>
              </header>
              <div>
                <label for="searchInput" class="text-[11px] font-semibold text-ink/55">Search</label>
                <input
                  id="searchInput"
                  name="q"
                  type="text"
                  placeholder="e.g., Frontend, Data, QA…"
                  class="mt-1 w-full rounded-xl border border-ink/15 bg-white px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-sky"
                />
              </div>
            </div>
          </section>
        </div>
      </aside>

      <!-- CONTENT -->
      <section class="col-span-12 lg:col-span-8" aria-labelledby="offers-title">
        <article class="rounded-2xl border border-ink/10 bg-white shadow-[0_10px_30px_rgba(0,23,31,0.06)]">
          <header class="flex items-center justify-between border-b border-ink/10 px-6 py-5">
            <div class="min-w-0">
              <h2 id="offers-title" class="truncate text-lg font-extrabold text-deep">Job Offers</h2>
              <p class="mt-1 text-xs text-ink/60">
                Manage offers, review matches by status, and track active reservations per offer.
              </p>
            </div>

            <div class="flex items-center gap-2">
              <div
                id="countBadge"
                class="rounded-full bg-cerulean/10 px-3 py-1 text-xs font-extrabold text-cerulean"
                aria-live="polite"
              >
                —
              </div>
            </div>
          </header>

          <section aria-label="Job offer list">
            <div id="offersList" class="divide-y divide-ink/10"></div>
          </section>

          <section id="emptyState" class="hidden px-6 py-10 text-center" aria-live="polite">
            <h3 class="text-sm font-extrabold text-deep">No Job Offers Found</h3>
            <p class="mt-1 text-xs text-ink/60">Create a new offer or adjust the filters.</p>
          </section>
        </article>
      </section>
    </main>

    <!-- MODAL: Create/Edit Offer -->
    <section id="modalOverlay" class="fixed inset-0 z-40 hidden" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="absolute inset-0 bg-black/30" aria-hidden="true"></div>

      <div class="relative mx-auto mt-16 w-[92%] max-w-2xl">
        <article class="rounded-2xl border border-ink/10 bg-white shadow-[0_20px_60px_rgba(0,23,31,0.20)]">
          <header class="flex items-center justify-between border-b border-ink/10 px-6 py-5">
            <div>
              <h2 id="modalTitle" class="text-lg font-extrabold text-deep">New Job Offer</h2>
              <p class="mt-1 text-xs text-ink/60">Complete the minimum required fields to publish.</p>
            </div>

            <button
              id="closeModalBtn"
              class="rounded-xl border border-ink/15 bg-white px-3 py-2 text-xs font-extrabold hover:bg-ink/5 focus:outline-none focus:ring-2 focus:ring-sky"
              type="button"
            >
              Close
            </button>
          </header>

          <div class="px-6 py-6">
            <form id="offerForm" class="space-y-5" aria-label="Create or edit job offer">
              <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                <div class="sm:col-span-2">
                  <label for="fTitle" class="text-[11px] font-semibold text-ink/55">Title *</label>
                  <input
                    id="fTitle"
                    name="title"
                    type="text"
                    placeholder="e.g., Frontend Developer"
                    class="mt-1 w-full rounded-xl border border-ink/15 px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-sky"
                  />
                </div>

                <div>
                  <label for="fLocation" class="text-[11px] font-semibold text-ink/55">Location *</label>
                  <input
                    id="fLocation"
                    name="location"
                    type="text"
                    placeholder="e.g., Remote / Medellín"
                    class="mt-1 w-full rounded-xl border border-ink/15 px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-sky"
                  />
                </div>

                <div>
                  <label for="fEmploymentType" class="text-[11px] font-semibold text-ink/55">Employment Type *</label>
                  <select
                    id="fEmploymentType"
                    name="employmentType"
                    class="mt-1 w-full rounded-xl border border-ink/15 px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-sky"
                  >
                    <option value="">—</option>
                    <option>Full-time</option>
                    <option>Part-time</option>
                    <option>Contract</option>
                    <option>Internship</option>
                  </select>
                </div>

                <div>
                  <label for="fStatus" class="text-[11px] font-semibold text-ink/55">Status *</label>
                  <select
                    id="fStatus"
                    name="status"
                    class="mt-1 w-full rounded-xl border border-ink/15 px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-sky"
                  >
                    <option value="">—</option>
                    <option value="open">open</option>
                    <option value="closed">closed</option>
                    <option value="draft">draft</option>
                  </select>
                </div>

                <div class="sm:col-span-2">
                  <label for="fDescription" class="text-[11px] font-semibold text-ink/55">Description *</label>
                  <textarea
                    id="fDescription"
                    name="description"
                    rows="3"
                    placeholder="e.g., React developer with experience in SPAs"
                    class="mt-1 w-full rounded-xl border border-ink/15 px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-sky"
                  ></textarea>
                </div>
              </div>

              <div class="flex flex-col gap-2 sm:flex-row sm:justify-end">
                <button
                  id="modalDeleteBtn"
                  class="hidden rounded-xl border border-red-200 bg-white px-3 py-2 text-xs font-extrabold text-red-700 hover:bg-red-50 focus:outline-none focus:ring-2 focus:ring-sky"
                  type="button"
                >
                  Delete
                </button>

                <button
                  id="modalSaveBtn"
                  class="rounded-xl bg-cerulean px-3 py-2 text-xs font-extrabold text-white hover:opacity-95 focus:outline-none focus:ring-2 focus:ring-sky"
                  type="button"
                >
                  Save
                </button>
              </div>

              <p id="modalError" class="hidden text-xs font-semibold text-red-700" role="alert"></p>
            </form>
          </div>
        </article>
      </div>
    </section>

    <script>
      // ---------- CONFIG ----------
      const API_BASE = "http://localhost:3000";
      const companyId = Number(localStorage.getItem("companyId") || 1);

      // ---------- DOM ----------
      const modalOverlay = document.getElementById("modalOverlay");
      const newOfferBtn = document.getElementById("newOfferBtn");
      const closeModalBtn = document.getElementById("closeModalBtn");

      const modalTitle = document.getElementById("modalTitle");
      const modalSaveBtn = document.getElementById("modalSaveBtn");
      const modalDeleteBtn = document.getElementById("modalDeleteBtn");
      const modalError = document.getElementById("modalError");
      const offerForm = document.getElementById("offerForm");

      const companyNameEl = document.getElementById("companyName");
      const companyTaglineEl = document.getElementById("companyTagline");
      const metricOffersEl = document.getElementById("metricOffers");
      const metricReservationsEl = document.getElementById("metricReservations");

      const offersListEl = document.getElementById("offersList");
      const emptyStateEl = document.getElementById("emptyState");
      const countBadgeEl = document.getElementById("countBadge");
      const searchInputEl = document.getElementById("searchInput");

      // form inputs
      const fTitle = document.getElementById("fTitle");
      const fLocation = document.getElementById("fLocation");
      const fEmploymentType = document.getElementById("fEmploymentType");
      const fStatus = document.getElementById("fStatus");
      const fDescription = document.getElementById("fDescription");

      // ---------- STATE ----------
      let offers = [];
      let matches = [];
      let reservations = [];
      let editingId = null;

      // ---------- MODAL ----------
      function openModal() {
        modalOverlay.classList.remove("hidden");
        document.body.classList.add("overflow-hidden");
      }

      function closeModal() {
        modalOverlay.classList.add("hidden");
        document.body.classList.remove("overflow-hidden");
        modalError.classList.add("hidden");
        modalError.textContent = "";
        editingId = null;
      }

      function showError(msg) {
        modalError.textContent = msg;
        modalError.classList.remove("hidden");
      }

      function todayISODate() {
      
        const d = new Date();
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, "0");
        const dd = String(d.getDate()).padStart(2, "0");
        return `${yyyy}-${mm}-${dd}`;
      }

      function getOfferPayloadFromForm() {
        return {
          companyId,
          title: fTitle.value.trim(),
          description: fDescription.value.trim(),
          location: fLocation.value.trim(),
          employmentType: fEmploymentType.value,
          status: fStatus.value,
          createdAt: todayISODate(),
        };
      }

      function setFormFromOffer(offer) {
        fTitle.value = offer.title || "";
        fDescription.value = offer.description || "";
        fLocation.value = offer.location || "";
        fEmploymentType.value = offer.employmentType || "";
        fStatus.value = offer.status || "";
      }

      // ---------- DATA FETCH ----------
      async function fetchJSON(path) {
        const res = await fetch(`${API_BASE}${path}`);
        if (!res.ok) {
          const text = await res.text();
          throw new Error(text || `Request failed: ${res.status}`);
        }
        return res.json();
      }

      async function loadAll() {
        // company
        const company = await fetchJSON(`/companies/${companyId}`);
        companyNameEl.textContent = company.name ?? "—";
        companyTaglineEl.textContent = company.description ?? company.industry ?? "—";

        // offers, matches, reservations
        [offers, matches, reservations] = await Promise.all([
          fetchJSON(`/jobOffers?companyId=${companyId}&_sort=createdAt&_order=desc`),
          fetchJSON(`/matches?companyId=${companyId}`),
          fetchJSON(`/reservations?companyId=${companyId}`),
        ]);

        renderMetrics();
        renderOffers();
      }

      function renderMetrics() {
        metricOffersEl.textContent = String(offers.length);

        const activeReservations = reservations.filter((r) => r.active === true);
        metricReservationsEl.textContent = String(activeReservations.length);
      }

      // ---------- DERIVED COUNTS ----------
      function countsForOffer(offerId) {
        const offerMatches = matches.filter((m) => m.jobOfferId === offerId);
        const byStatus = offerMatches.reduce((acc, m) => {
          acc[m.status] = (acc[m.status] || 0) + 1;
          return acc;
        }, {});
        const activeRes = reservations.filter((r) => r.jobOfferId === offerId && r.active === true).length;

        return {
          pending: byStatus.pending || 0,
          hired: byStatus.hired || 0,
          rejected: byStatus.rejected || 0,
          totalMatches: offerMatches.length,
          activeReservations: activeRes,
        };
      }

      // ---------- RENDER ----------
      function renderOffers() {
        const q = (searchInputEl.value || "").trim().toLowerCase();
        const filtered = offers.filter((o) => (o.title || "").toLowerCase().includes(q));

        countBadgeEl.textContent = `${filtered.length} offer${filtered.length === 1 ? "" : "s"}`;

        offersListEl.innerHTML = "";

        if (filtered.length === 0) {
          emptyStateEl.classList.remove("hidden");
          return;
        }
        emptyStateEl.classList.add("hidden");

        filtered.forEach((offer) => {
          const c = countsForOffer(offer.id);

          const statusPill =
            offer.status === "open"
              ? "bg-green-100 text-green-800"
              : offer.status === "closed"
              ? "bg-gray-200 text-gray-800"
              : "bg-yellow-100 text-yellow-800";

          const row = document.createElement("div");
          row.className = "px-6 py-5";
          row.innerHTML = `
            <div class="flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between">
              <div class="min-w-0">
                <div class="flex flex-wrap items-center gap-2">
                  <h3 class="truncate text-sm font-extrabold text-deep">${escapeHTML(offer.title || "Untitled")}</h3>
                  <span class="rounded-full px-2 py-1 text-[11px] font-extrabold ${statusPill}">
                    ${escapeHTML(offer.status || "—")}
                  </span>
                </div>

                <p class="mt-1 text-xs text-ink/60">
                  ${escapeHTML(offer.location || "—")} • ${escapeHTML(offer.employmentType || "—")} • Created: ${escapeHTML(offer.createdAt || "—")}
                </p>

                <p class="mt-2 text-xs text-ink/80">
                  ${escapeHTML(offer.description || "")}
                </p>

                <dl class="mt-3 grid grid-cols-2 gap-2 text-xs sm:grid-cols-4">
                  <div class="rounded-xl bg-ink/5 p-3">
                    <dt class="font-semibold text-ink/60">Matches</dt>
                    <dd class="mt-1 text-sm font-extrabold text-deep">${c.totalMatches}</dd>
                  </div>
                  <div class="rounded-xl bg-ink/5 p-3">
                    <dt class="font-semibold text-ink/60">Pending</dt>
                    <dd class="mt-1 text-sm font-extrabold text-deep">${c.pending}</dd>
                  </div>
                  <div class="rounded-xl bg-ink/5 p-3">
                    <dt class="font-semibold text-ink/60">Hired</dt>
                    <dd class="mt-1 text-sm font-extrabold text-deep">${c.hired}</dd>
                  </div>
                  <div class="rounded-xl bg-ink/5 p-3">
                    <dt class="font-semibold text-ink/60">Active Res.</dt>
                    <dd class="mt-1 text-sm font-extrabold text-deep">${c.activeReservations}</dd>
                  </div>
                </dl>
              </div>

              <div class="flex shrink-0 items-center gap-2">
                <button
                  class="editBtn rounded-xl border border-ink/15 bg-white px-3 py-2 text-xs font-extrabold hover:bg-ink/5 focus:outline-none focus:ring-2 focus:ring-sky"
                  type="button"
                  data-id="${offer.id}"
                >
                  Edit
                </button>
              </div>
            </div>
          `;

          offersListEl.appendChild(row);
        });

        // hook edit buttons
        offersListEl.querySelectorAll(".editBtn").forEach((btn) => {
          btn.addEventListener("click", () => {
            const id = Number(btn.getAttribute("data-id"));
            const offer = offers.find((o) => o.id === id);
            if (!offer) return;

            editingId = id;
            modalTitle.textContent = "Edit Job Offer";
            modalDeleteBtn.classList.remove("hidden");
            offerForm.reset();
            setFormFromOffer(offer);
            openModal();
          });
        });
      }

      function escapeHTML(str) {
        return String(str)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      // ---------- EVENTS ----------
      newOfferBtn.addEventListener("click", () => {
        editingId = null;
        modalTitle.textContent = "New Job Offer";
        modalDeleteBtn.classList.add("hidden");
        offerForm.reset();
        // sensible defaults
        fStatus.value = "open";
        fEmploymentType.value = "Full-time";
        openModal();
      });

      closeModalBtn.addEventListener("click", closeModal);

      searchInputEl.addEventListener("input", renderOffers);

      modalSaveBtn.addEventListener("click", async () => {
        modalError.classList.add("hidden");
        modalError.textContent = "";

        const payload = getOfferPayloadFromForm();

        // minimal validation
        if (!payload.title) return showError("Title is required.");
        if (!payload.location) return showError("Location is required.");
        if (!payload.employmentType) return showError("Employment Type is required.");
        if (!payload.status) return showError("Status is required.");
        if (!payload.description) return showError("Description is required.");

        try {
          const url = editingId ? `${API_BASE}/jobOffers/${editingId}` : `${API_BASE}/jobOffers`;
          const method = editingId ? "PATCH" : "POST";

          const res = await fetch(url, {
            method,
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          if (!res.ok) {
            const text = await res.text();
            throw new Error(text || `Request failed with status ${res.status}`);
          }

          closeModal();
          await loadAll();
        } catch (err) {
          console.error(err);
          showError("Could not save offer. Is JSON Server running on port 3001?");
        }
      });

      modalDeleteBtn.addEventListener("click", async () => {
        if (!editingId) return;

        try {
          const res = await fetch(`${API_BASE}/jobOffers/${editingId}`, { method: "DELETE" });
          if (!res.ok) {
            const text = await res.text();
            throw new Error(text || `Delete failed with status ${res.status}`);
          }

          closeModal();
          await loadAll();
        } catch (err) {
          console.error(err);
          showError("Could not delete offer. Is JSON Server running on port 3001?");
        }
      });

      // ---------- INIT ----------
      loadAll().catch((err) => {
        console.error(err);
        
        companyNameEl.textContent = "—";
        companyTaglineEl.textContent = "Could not load data (is JSON Server running?)";
        metricOffersEl.textContent = "—";
        metricReservationsEl.textContent = "—";
        countBadgeEl.textContent = "—";
      });
    </script>
  </body>
</html>
